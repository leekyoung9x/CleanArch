<?xml version="1.0" encoding="utf-8" ?>
<nlog throwExceptions="true" xmlns="http://www.nlog-project.org/schemas/NLog.xsd"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

  <!-- Biến chứa token cho Elasticsearch authentication -->
  <variable name="token" value="Basic ZWxhc3RpYzoxMjM0NTY3OEBBYmM=" />

  <targets>
    <!-- Console có màu sắc theo log level để dễ đọc -->
    <target name="coloredConsole" xsi:type="ColoredConsole" 
            layout="${shortdate} [${level:uppercase=true:padding=5}] ${logger:shortName=true} - ${message} ${exception}">
      <highlight-row condition="level == LogLevel.Debug" foregroundColor="Gray" />
      <highlight-row condition="level == LogLevel.Info" foregroundColor="Green" />
      <highlight-row condition="level == LogLevel.Warn" foregroundColor="Yellow" />
      <highlight-row condition="level == LogLevel.Error" foregroundColor="Red" />
      <highlight-row condition="level == LogLevel.Fatal" foregroundColor="Magenta" />
    </target>

    <!-- Ghi log vào file để lưu trữ lâu dài -->
    <target name="file" xsi:type="File" 
            fileName="logs/app-${shortdate}.log" 
            layout="${longdate} [${level:uppercase=true:padding=5}] ${logger} - ${message} ${exception:format=tostring}" 
            archiveEvery="Day"
            archiveNumbering="Rolling"
            maxArchiveFiles="30" />

    <!-- Ghi log lên Elasticsearch để monitoring và analytics -->
    <target name="elk"
            xsi:type="WebService"
            url="http://157.245.153.39:9200/log/_doc"
            encoding="UTF-8"
            protocol="JsonPost"
            preAuthenticate="True">
        <header name="Authorization" layout="${token}" />
        <parameter name="level" layout="${level}" />
        <parameter name="message" layout="${message}" />
        <parameter name="logger" layout="${logger}" />
        <parameter name="timestamp" layout="${date:format=yyyy-MM-ddTHH\:mm\:ss.fffZ}" />
    </target>
  </targets>

  <rules>
    <!-- =====================================================================================
         LOGGING RULES - THỨ TỰ QUAN TRỌNG! 
         NLog sẽ áp dụng rule đầu tiên phù hợp, nên rule cụ thể phải đặt trước rule chung
         ===================================================================================== -->
    
    <!-- 1. RULE ĐẶC BIỆT: Debug logging cho TransactionBankingController -->
    <!--    Mục đích: Debug ConfirmTransaction API để troubleshoot issues -->
    <!--    Level: INFO trở lên (INFO, WARN, ERROR, FATAL) -->
    <!--    Output: Console có màu + File logs -->
    <logger name="CleanArch.Api.Controllers.TransactionBankingController" 
            minlevel="Info" 
            writeTo="coloredConsole,file" 
            final="true" />
    
    <!-- 2. RULE CHUNG: Tất cả controllers khác -->
    <!--    Mục đích: Chỉ log errors quan trọng để tiết kiệm performance -->
    <!--    Level: ERROR trở lên (ERROR, FATAL) -->
    <!--    Output: Console có màu + File logs -->
    <logger name="*" 
            minlevel="Error" 
            writeTo="coloredConsole,file" />
    
    <!-- 3. ELASTICSEARCH: Chỉ ghi ERROR logs để tiết kiệm chi phí storage -->
    <!--    Tất cả controllers (bao gồm TransactionBankingController) -->
    <!--    Chỉ ERROR và FATAL được gửi lên ELK stack -->
    <logger name="*" 
            minlevel="Error" 
            writeTo="elk" />
  </rules>
</nlog>
